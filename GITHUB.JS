////////////////////////////////////////////////////////////////////////////////
// FixFlowBot â€“ Enhanced & Modular â€“ Updated 2025-07-31
////////////////////////////////////////////////////////////////////////////////
// [1] Configuration & Constants
////////////////////////////////////////////////////////////////////////////////
const BOT_TOKEN = '8384799464:AAHLlXJhUWm0AuXoyHX7iffcFJiG7l9U4e0';
const SHEET_NAME = 'Sheet1';  // ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯
const REG_SHEET_NAME = 'Registrations'; // ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯
const DRIVE_FOLDER_ID = '1-BTY6cG1qmSJ0aWU8D4AXOkB8gULMGHL';
const TIMELINE_SHEET_NAME = 'Timeline'; // Ø¬Ø¯ÙˆÙ„ Ø¬Ø¯ÙŠØ¯ Ù„ØªØªØ¨Ø¹ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨Ø§Øª

const ADMIN_IDS = [7103238318];
const TECH_IDS = [7500135526];

// Cache spreadsheet references
const spreadsheet = SpreadsheetApp.openById('1THbDwp8EEW0oaAhlv8LI-qEvvcOR5st_uLZBeqL-91s');
const regSheet = spreadsheet.getSheetByName(REG_SHEET_NAME); // ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ ÙˆØ±Ù‚Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª
const dataSheet = spreadsheet.getSheetByName(SHEET_NAME); // ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
let timelineSheet;

try {
  timelineSheet = spreadsheet.getSheetByName(TIMELINE_SHEET_NAME);
  // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Timeline Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (!timelineSheet) {
    timelineSheet = spreadsheet.insertSheet(TIMELINE_SHEET_NAME);
    timelineSheet.appendRow([
      'Request ID', 'Status', 'Updated By', 'Comments', 'Timestamp'
    ]);
  }
} catch (err) {
  Logger.log(`Timeline sheet initialization error: ${err.message}`);
}

// User states - Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
const STATES = {
  AWAITING_REG_PHONE: 'awaiting_reg_phone',
  AWAITING_REG_USERNAME: 'awaiting_reg_username',
  AWAITING_REG_PASSWORD: 'awaiting_reg_password',
  AWAITING_LOGIN_USERNAME: 'awaiting_login_username',
  AWAITING_LOGIN_PASSWORD: 'awaiting_login_password',
  AWAITING_TYPE: 'awaiting_type',
  AWAITING_LOCATION: 'awaiting_location',
  AWAITING_DESCRIPTION: 'awaiting_description',
  AWAITING_IMAGE: 'awaiting_image',
  AWAITING_CONFIRMATION: 'awaiting_confirmation',
  // Ø­Ø§Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
  AWAITING_ASSIGN_TECH: 'awaiting_assign_tech',
  AWAITING_PRIORITY: 'awaiting_priority',
  AWAITING_STATUS_UPDATE: 'awaiting_status_update',
  AWAITING_COMMENT: 'awaiting_comment'
};

// Suggested issues by type - Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
const SUGGESTED_ISSUES = {
  civil: ['Broken tiles', 'Wall crack', 'Ceiling damage', 'Door issue'],
  electrical: ['Light not working', 'Power outlet issue', 'Circuit breaker tripped', 'Fan not working'],
  mechanical: ['Water leakage', 'AC not cooling', 'Heating issue', 'Plumbing problem']
};

// Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª
const STATUS = {
  OPEN: 'Open',
  IN_PROGRESS: 'In Progress',
  CLOSED: 'Closed',
  PENDING: 'Pending',
  REJECTED: 'Rejected'
};

// Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
const ROLES = {
  TECH: 'Tech',
  USER: 'User',
  SUPERVISOR: 'Supervisor',
  ADMIN: 'Admin'
};

// Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª
const PRIORITIES = {
  LOW: 'Low',
  MEDIUM: 'Medium',
  HIGH: 'High',
  URGENT: 'Urgent'
};

// ÙˆÙ‚Øª ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø¨Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)
const REMINDER_DAYS = {
  OPEN: 3,        // ØªØ°ÙƒÙŠØ± Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø¨Ø¹Ø¯ 3 Ø£ÙŠØ§Ù…
  IN_PROGRESS: 5  // ØªØ°ÙƒÙŠØ± Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø¹Ø¯ 5 Ø£ÙŠØ§Ù…
};

////////////////////////////////////////////////////////////////////////////////
// [2] Entry Point
////////////////////////////////////////////////////////////////////////////////
function doPost(e) {
  try {
    const update = JSON.parse(e.postData.contents);
    Logger.log(`Processing update: ${JSON.stringify(update)}`);
    
    if (update.callback_query) {
      return handleCallback(update.callback_query);
    }
    if (update.message) {
      return handleMessage(update.message, update);
    }
  } catch (err) {
    Logger.log(`doPost error: ${err.message}\n${err.stack}`);
    // Notify admins about the error
    ADMIN_IDS.forEach(adminId => {
      sendMessage(adminId, `âš ï¸ System error: ${err.message}`);
    });
  }
  return HtmlService.createHtmlOutput('ok');
}

////////////////////////////////////////////////////////////////////////////////
// [3] Message Handler
////////////////////////////////////////////////////////////////////////////////
function handleMessage(msg, update) {
  const userId = msg.from.id;
  const chatId = msg.chat.id;
  const text = (msg.text || '').trim();
  const lower = text.toLowerCase();
  const userProps = PropertiesService.getUserProperties();
  const state = userProps.getProperty(String(chatId));

  try {
    // Process main commands and states
    if (lower === '/start') {
      resetUserState(userProps, chatId);
      showMainMenu(chatId, userId);
      return HtmlService.createHtmlOutput('ok');
    }
    
    // Handle registration and login
    if (handleRegistrationFlow(msg, update, userProps, chatId, userId, text, lower, state)) {
      return HtmlService.createHtmlOutput('ok');
    }
    
    // Check user authorization
    if (!isAuthorized(userId)) {
      showMainMenu(chatId, userId);
      return HtmlService.createHtmlOutput('ok');
    }
    
    // Handle new admin commands
    if (handleAdminCommands(msg, chatId, userId, text, lower, state, userProps)) {
      return HtmlService.createHtmlOutput('ok');
    }
    
    // Handle authorized user commands
    if (handleAuthorizedCommands(msg, chatId, userId, text, lower, state, userProps)) {
      return HtmlService.createHtmlOutput('ok');
    }
    
    // Handle issue reporting workflow
    if (handleIssueReportFlow(msg, chatId, userId, text, lower, state, userProps)) {
      return HtmlService.createHtmlOutput('ok');
    }
    
    // Handle advanced admin states (new)
    if (handleAdvancedAdminFlow(msg, chatId, userId, text, lower, state, userProps)) {
      return HtmlService.createHtmlOutput('ok');
    }
    
    // Default - show main menu
    sendMessage(chatId, 'âš ï¸ Please use the menu below.', {
      reply_markup: { remove_keyboard: true }
    });
    showMainMenu(chatId, userId);
    
  } catch (err) {
    Logger.log(`handleMessage error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ An error occurred while processing your request. Please try again.');
    resetUserState(userProps, chatId);
    showMainMenu(chatId, userId);
  }
  
  return HtmlService.createHtmlOutput('ok');
}

////////////////////////////////////////////////////////////////////////////////
// [4.0] New Admin Commands Handler - Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
////////////////////////////////////////////////////////////////////////////////
/**
 * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
 */
function handleAdminCommands(msg, chatId, userId, text, lower, state, userProps) {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±Ù
  if (!isAdmin(userId)) {
    return false;
  }
  
  // Ø£ÙˆØ§Ù…Ø± Ø¥Ø¯Ø§Ø±ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
  if (lower === '/users' || lower === 'users') {
    showUserManagement(chatId);
    return true;
  }
  
  if (lower === '/assign' || lower === 'assign') {
    showAssignmentMenu(chatId);
    return true;
  }
  
  if (lower === '/dashboard' || lower === 'dashboard') {
    showAdminDashboard(chatId);
    return true;
  }
  
  if (lower === '/report' || lower === 'report') {
    showWebReport(chatId);
    return true;
  }
  
  if (lower === '/check_pending' || lower === 'check pending') {
    checkPendingRequests(chatId);
    return true;
  }
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
  if (state === STATES.AWAITING_ASSIGN_TECH) {
    handleTechAssignment(chatId, text, userProps);
    return true;
  }
  
  if (state === STATES.AWAITING_PRIORITY) {
    handlePriorityAssignment(chatId, text, userProps);
    return true;
  }
  
  if (state === STATES.AWAITING_STATUS_UPDATE) {
    handleStatusUpdate(chatId, text, userProps, userId);
    return true;
  }
  
  if (state === STATES.AWAITING_COMMENT) {
    handleCommentAddition(chatId, text, userProps, userId);
    return true;
  }
  
  return false;
}

/**
 * Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
 */
function showUserManagement(chatId) {
  try {
    const data = regSheet.getDataRange().getValues();
    const users = [];
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
    const usersByRole = {
      'Admin': [],
      'Tech': [],
      'Supervisor': [],
      'User': []
    };
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][6] === 'Accepted') {
        const role = data[i][7] || 'User';
        usersByRole[role].push({
          id: data[i][0],
          name: data[i][1],
          username: data[i][3],
          rowIdx: i
        });
      }
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬Ø²Ø© Ø¨Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    const summary = `ğŸ‘¥ User Management\n\nTotal Users: ${data.length - 1}\n` +
      `â€¢ Admins: ${usersByRole['Admin'].length}\n` +
      `â€¢ Techs: ${usersByRole['Tech'].length}\n` +
      `â€¢ Supervisors: ${usersByRole['Supervisor'].length}\n` +
      `â€¢ Regular Users: ${usersByRole['User'].length}\n\n` +
      `Select a category to view users:`;
    
    sendMessage(chatId, summary, {
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'ğŸ‘® Admins', callback_data: 'users:list:Admin:1' },
            { text: 'ğŸ‘¨â€ğŸ”§ Techs', callback_data: 'users:list:Tech:1' }
          ],
          [
            { text: 'ğŸ‘¨â€ğŸ’¼ Supervisors', callback_data: 'users:list:Supervisor:1' },
            { text: 'ğŸ‘¤ Users', callback_data: 'users:list:User:1' }
          ],
          [{ text: 'â¬…ï¸ Back to Admin Panel', callback_data: 'admin_panel' }]
        ]
      }
    });
  } catch (err) {
    Logger.log(`showUserManagement error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error displaying user management.');
  }
}

/**
 * Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± Ù…Ø¹ ØµÙØ­Ø§Øª
 */
function listUsersByRole(chatId, role, page = 1) {
  try {
    const data = regSheet.getDataRange().getValues();
    const users = [];
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø­Ø¯Ø¯
    for (let i = 1; i < data.length; i++) {
      if (data[i][6] === 'Accepted' && data[i][7] === role) {
        users.push({
          id: data[i][0],
          name: data[i][1],
          username: data[i][3],
          rowIdx: i
        });
      }
    }
    
    const itemsPerPage = 5;
    const totalPages = Math.ceil(users.length / itemsPerPage);
    const startIdx = (page - 1) * itemsPerPage;
    const endIdx = Math.min(startIdx + itemsPerPage, users.length);
    const usersToShow = users.slice(startIdx, endIdx);
    
    if (usersToShow.length === 0) {
      sendMessage(chatId, `No users found with ${role} role.`, {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back', callback_data: 'users:manage' }]
          ]
        }
      });
      return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    let userList = `ğŸ‘¥ ${role}s (Page ${page}/${totalPages || 1}):\n\n`;
    usersToShow.forEach(user => {
      userList += `â€¢ ${user.name} (@${user.username}) - ID: ${user.id}\n`;
    });
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
    const inlineKeyboard = [];
    
    // Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ÙŠÙ†
    usersToShow.forEach(user => {
      inlineKeyboard.push([
        { text: `âœï¸ ${user.name}`, callback_data: `users:edit:${user.rowIdx}` }
      ]);
    });
    
    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
    const navigationRow = [];
    if (page > 1) {
      navigationRow.push({ text: 'â—€ï¸ Previous', callback_data: `users:list:${role}:${page - 1}` });
    }
    if (page < totalPages) {
      navigationRow.push({ text: 'Next â–¶ï¸', callback_data: `users:list:${role}:${page + 1}` });
    }
    
    if (navigationRow.length > 0) {
      inlineKeyboard.push(navigationRow);
    }
    
    inlineKeyboard.push([{ text: 'â¬…ï¸ Back', callback_data: 'users:manage' }]);
    
    sendMessage(chatId, userList, {
      reply_markup: {
        inline_keyboard: inlineKeyboard
      }
    });
  } catch (err) {
    Logger.log(`listUsersByRole error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error listing users.');
  }
}

/**
 * Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
 */
function showUserEditMenu(chatId, rowIdx) {
  try {
    const data = regSheet.getDataRange().getValues();
    if (rowIdx >= data.length) {
      sendMessage(chatId, 'âŒ User not found.');
      return;
    }
    
    const user = data[rowIdx];
    const userId = user[0];
    const name = user[1];
    const phone = user[2];
    const username = user[3];
    const regDate = user[5] ? new Date(user[5]).toLocaleDateString() : 'Unknown';
    const status = user[6] || 'Pending';
    const role = user[7] || 'User';
    
    const userInfo = `ğŸ‘¤ User Details:\n\n` +
      `Name: ${name}\n` +
      `Username: ${username}\n` +
      `Phone: ${phone}\n` +
      `ID: ${userId}\n` +
      `Registered: ${regDate}\n` +
      `Status: ${status}\n` +
      `Role: ${role}\n\n` +
      `Select an action:`;
    
    const inlineKeyboard = [
      [
        { text: 'ğŸ‘· Set Tech', callback_data: `users:role:${rowIdx}:Tech` },
        { text: 'ğŸ‘¤ Set User', callback_data: `users:role:${rowIdx}:User` }
      ],
      [
        { text: 'ğŸ§‘â€ğŸ’¼ Set Supervisor', callback_data: `users:role:${rowIdx}:Supervisor` },
        { text: 'ğŸ›¡ï¸ Set Admin', callback_data: `users:role:${rowIdx}:Admin` }
      ],
      [
        { text: status === 'Accepted' ? 'âŒ Deactivate' : 'âœ… Activate', 
          callback_data: status === 'Accepted' ? 
            `users:status:${rowIdx}:Rejected` : 
            `users:status:${rowIdx}:Accepted` }
      ],
      [
        { text: 'ğŸ—‘ï¸ Delete', callback_data: `users:delete:${rowIdx}` },
        { text: 'â¬…ï¸ Back', callback_data: `users:list:${role}:1` }
      ]
    ];
    
    sendMessage(chatId, userInfo, {
      reply_markup: {
        inline_keyboard: inlineKeyboard
      }
    });
  } catch (err) {
    Logger.log(`showUserEditMenu error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error showing user edit menu.');
  }
}

/**
 * ØªØºÙŠÙŠØ± Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
 */
function changeUserRole(chatId, rowIdx, newRole) {
  try {
    const data = regSheet.getDataRange().getValues();
    if (rowIdx >= data.length) {
      sendMessage(chatId, 'âŒ User not found.');
      return;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    regSheet.getRange(rowIdx + 1, 8).setValue(newRole);
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¯ÙˆØ± Ù‡Ùˆ ÙÙ†ÙŠØŒ Ø£Ø¶ÙÙ‡ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†
    const userId = data[rowIdx][0];
    if (newRole === ROLES.TECH && !TECH_IDS.includes(Number(userId))) {
      TECH_IDS.push(Number(userId));
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù…Ø´Ø±Ù
    sendMessage(chatId, `âœ… User role updated to ${newRole}.`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'â¬…ï¸ Back to User', callback_data: `users:edit:${rowIdx}` }],
          [{ text: 'ğŸ‘¥ User Management', callback_data: 'users:manage' }]
        ]
      }
    });
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    sendMessage(userId, `ğŸ“¢ Your role has been updated to ${newRole}.`);
  } catch (err) {
    Logger.log(`changeUserRole error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error updating user role.');
  }
}

/**
 * ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù†Ø´Ø·/ØºÙŠØ± Ù†Ø´Ø·)
 */
function changeUserStatus(chatId, rowIdx, newStatus) {
  try {
    const data = regSheet.getDataRange().getValues();
    if (rowIdx >= data.length) {
      sendMessage(chatId, 'âŒ User not found.');
      return;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    regSheet.getRange(rowIdx + 1, 7).setValue(newStatus);
    
    const userId = data[rowIdx][0];
    const statusText = newStatus === 'Accepted' ? 'activated' : 'deactivated';
    
    // Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù…Ø´Ø±Ù
    sendMessage(chatId, `âœ… User account ${statusText}.`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'â¬…ï¸ Back to User', callback_data: `users:edit:${rowIdx}` }],
          [{ text: 'ğŸ‘¥ User Management', callback_data: 'users:manage' }]
        ]
      }
    });
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    sendMessage(userId, `ğŸ“¢ Your account has been ${statusText}.`);
  } catch (err) {
    Logger.log(`changeUserStatus error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error updating user status.');
  }
}

/**
 * Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
 */
function deleteUser(chatId, rowIdx) {
  try {
    const data = regSheet.getDataRange().getValues();
    if (rowIdx >= data.length) {
      sendMessage(chatId, 'âŒ User not found.');
      return;
    }
    
    const userId = data[rowIdx][0];
    const username = data[rowIdx][3];
    
    // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    regSheet.deleteRow(rowIdx + 1);
    
    // Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù…Ø´Ø±Ù
    sendMessage(chatId, `âœ… User ${username} has been deleted.`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ‘¥ User Management', callback_data: 'users:manage' }]
        ]
      }
    });
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    try {
      sendMessage(userId, `ğŸ“¢ Your account has been deleted by an administrator.`);
    } catch (err) {
      // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø°ÙˆÙ
      Logger.log(`Could not notify deleted user: ${err.message}`);
    }
  } catch (err) {
    Logger.log(`deleteUser error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error deleting user.');
  }
}

/**
 * Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª
 */
function showAssignmentMenu(chatId) {
  try {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© ØºÙŠØ± Ø§Ù„Ù…Ø¹ÙŠÙ†Ø©
    const data = dataSheet.getDataRange().getValues();
    const unassignedRequests = data.filter((row, idx) => 
      idx > 0 && row[1] === STATUS.OPEN && !row[3]
    );
    
    if (unassignedRequests.length === 0) {
      sendMessage(chatId, 'âœ… No unassigned open requests.', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back to Admin Panel', callback_data: 'admin_panel' }]
          ]
        }
      });
      return;
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¹ÙŠÙ†Ø©
    let message = 'ğŸ”„ Unassigned Open Requests:\n\n';
    const keyboard = [];
    
    unassignedRequests.forEach(row => {
      message += `â€¢ Request #${row[0]} - ${row[2]} - ${row[5]}: ${row[8].substring(0, 30)}${row[8].length > 30 ? '...' : ''}\n`;
      keyboard.push([
        { text: `Assign #${row[0]}`, callback_data: `assign:request:${row[0]}` }
      ]);
    });
    
    keyboard.push([
      { text: 'â¬…ï¸ Back to Admin Panel', callback_data: 'admin_panel' }
    ]);
    
    sendMessage(chatId, message, {
      reply_markup: {
        inline_keyboard: keyboard
      }
    });
  } catch (err) {
    Logger.log(`showAssignmentMenu error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error showing assignment menu.');
  }
}

/**
 * Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ù„Ø§Øº Ù„Ø£Ø­Ø¯Ù‡Ù…
 */
function showTechList(chatId, requestId) {
  try {
    // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†
    const data = regSheet.getDataRange().getValues();
    const techs = data.filter(row => 
      row[6] === 'Accepted' && row[7] === ROLES.TECH
    );
    
    if (techs.length === 0) {
      sendMessage(chatId, 'âŒ No techs available for assignment.', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back', callback_data: 'assign:menu' }]
          ]
        }
      });
      return;
    }
    
    // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº
    const userProps = PropertiesService.getUserProperties();
    userProps.setProperty(String(chatId) + '_assign_request_id', requestId);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†
    let message = `ğŸ‘¨â€ğŸ”§ Select a technician to assign request #${requestId}:\n\n`;
    const keyboard = [];
    
    techs.forEach(tech => {
      keyboard.push([
        { text: tech[1] || tech[3], callback_data: `assign:tech:${tech[0]}` }
      ]);
    });
    
    keyboard.push([
      { text: 'â¬…ï¸ Back', callback_data: 'assign:menu' }
    ]);
    
    sendMessage(chatId, message, {
      reply_markup: {
        inline_keyboard: keyboard
      }
    });
  } catch (err) {
    Logger.log(`showTechList error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error showing tech list.');
  }
}

/**
 * ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ Ù„Ø¨Ù„Ø§Øº Ù…Ø­Ø¯Ø¯
 */
function assignTechToRequest(chatId, techId) {
  try {
    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ù† Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userProps = PropertiesService.getUserProperties();
    const requestId = userProps.getProperty(String(chatId) + '_assign_request_id');
    
    if (!requestId) {
      sendMessage(chatId, 'âŒ Request ID not found.', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back', callback_data: 'assign:menu' }]
          ]
        }
      });
      return;
    }
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙ Ø§Ù„Ø¨Ù„Ø§Øº
    const data = dataSheet.getDataRange().getValues();
    let rowIdx = -1;
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]) === String(requestId)) {
        rowIdx = i;
        break;
      }
    }
    
    if (rowIdx === -1) {
      sendMessage(chatId, 'âŒ Request not found.', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back', callback_data: 'assign:menu' }]
          ]
        }
      });
      return;
    }
    
    // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ
    const techName = getUserNameById(techId);
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ†ÙŠ Ù„Ù„Ø¨Ù„Ø§Øº ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ®
    const now = new Date();
    dataSheet.getRange(rowIdx + 1, 4).setValue(techId); // Assigned To
    dataSheet.getRange(rowIdx + 1, 14).setValue(now); // Assigned Date
    
    // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
    recordTimeline(requestId, 'Assigned', chatId, `Assigned to ${techName || techId}`, now);
    
    // Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù…Ø´Ø±Ù
    sendMessage(chatId, `âœ… Request #${requestId} assigned to ${techName || techId}.`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'Set Priority', callback_data: `request:priority:${requestId}` }],
          [{ text: 'â¬…ï¸ Back', callback_data: 'assign:menu' }]
        ]
      }
    });
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ÙÙ†ÙŠ
    const requestDetails = data[rowIdx];
    const requestType = requestDetails[2];
    const requestLocation = requestDetails[5];
    const requestDescription = requestDetails[8];
    
    sendMessage(techId, `ğŸ”” New Assignment: Request #${requestId}\nType: ${requestType}\nLocation: ${requestLocation}\nDescription: ${requestDescription}`);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø¨Ù„Ø§Øº
    const createdBy = requestDetails[10];
    if (createdBy && !isNaN(createdBy)) {
      sendMessage(createdBy, `ğŸ”” Update: Your request #${requestId} has been assigned to a technician.`);
    }
    
    // Ù…Ø³Ø­ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ù† Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    userProps.deleteProperty(String(chatId) + '_assign_request_id');
  } catch (err) {
    Logger.log(`assignTechToRequest error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error assigning tech to request.');
  }
}

/**
 * Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø¨Ù„Ø§Øº
 */
function showPriorityMenu(chatId, requestId) {
  try {
    // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº ÙÙŠ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userProps = PropertiesService.getUserProperties();
    userProps.setProperty(String(chatId) + '_priority_request_id', requestId);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
    sendMessage(chatId, `ğŸ”¢ Select priority for request #${requestId}:`, {
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'ğŸŸ¢ Low', callback_data: 'priority:set:Low' },
            { text: 'ğŸŸ¡ Medium', callback_data: 'priority:set:Medium' }
          ],
          [
            { text: 'ğŸŸ  High', callback_data: 'priority:set:High' },
            { text: 'ğŸ”´ Urgent', callback_data: 'priority:set:Urgent' }
          ],
          [
            { text: 'â¬…ï¸ Back', callback_data: 'admin_panel' }
          ]
        ]
      }
    });
  } catch (err) {
    Logger.log(`showPriorityMenu error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error showing priority menu.');
  }
}

/**
 * ØªØ¹ÙŠÙŠÙ† Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ø¨Ù„Ø§Øº
 */
function setPriorityForRequest(chatId, priority) {
  try {
    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ù† Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userProps = PropertiesService.getUserProperties();
    const requestId = userProps.getProperty(String(chatId) + '_priority_request_id');
    
    if (!requestId) {
      sendMessage(chatId, 'âŒ Request ID not found.', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back', callback_data: 'admin_panel' }]
          ]
        }
      });
      return;
    }
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙ Ø§Ù„Ø¨Ù„Ø§Øº
    const data = dataSheet.getDataRange().getValues();
    let rowIdx = -1;
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]) === String(requestId)) {
        rowIdx = i;
        break;
      }
    }
    
    if (rowIdx === -1) {
      sendMessage(chatId, 'âŒ Request not found.', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back', callback_data: 'admin_panel' }]
          ]
        }
      });
      return;
    }
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø¨Ù„Ø§Øº
    dataSheet.getRange(rowIdx + 1, 5).setValue(priority); // Priority
    
    // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
    recordTimeline(requestId, 'Priority Updated', chatId, `Priority set to ${priority}`);
    
    // Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù…Ø´Ø±Ù
    sendMessage(chatId, `âœ… Priority for request #${requestId} set to ${priority}.`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'Update Status', callback_data: `request:status:${requestId}` }],
          [{ text: 'â¬…ï¸ Back to Admin Panel', callback_data: 'admin_panel' }]
        ]
      }
    });
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø¹ÙŠÙ† (Ø¥Ù† ÙˆØ¬Ø¯)
    const assignedTo = data[rowIdx][3];
    if (assignedTo) {
      sendMessage(assignedTo, `ğŸ”” Update: Priority for request #${requestId} has been set to ${priority}.`);
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø¨Ù„Ø§Øº
    const createdBy = data[rowIdx][10];
    if (createdBy && !isNaN(createdBy)) {
      sendMessage(createdBy, `ğŸ”” Update: Your request #${requestId} has been assigned ${priority} priority.`);
    }
    
    // Ù…Ø³Ø­ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ù† Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    userProps.deleteProperty(String(chatId) + '_priority_request_id');
  } catch (err) {
    Logger.log(`setPriorityForRequest error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error setting priority for request.');
  }
}

/**
 * Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº
 */
function showStatusUpdateMenu(chatId, requestId) {
  try {
    // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº ÙÙŠ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userProps = PropertiesService.getUserProperties();
    userProps.setProperty(String(chatId) + '_status_request_id', requestId);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
    sendMessage(chatId, `ğŸ”„ Select new status for request #${requestId}:`, {
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'ğŸ”´ Open', callback_data: 'status:set:Open' },
            { text: 'ğŸŸ  In Progress', callback_data: 'status:set:In Progress' }
          ],
          [
            { text: 'ğŸŸ¢ Closed', callback_data: 'status:set:Closed' },
            { text: 'âšª Pending', callback_data: 'status:set:Pending' }
          ],
          [
            { text: 'â¬…ï¸ Back', callback_data: 'admin_panel' }
          ]
        ]
      }
    });
  } catch (err) {
    Logger.log(`showStatusUpdateMenu error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error showing status update menu.');
  }
}

/**
 * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø¨Ù„Ø§Øº
 */
function updateRequestStatus(chatId, status) {
  try {
    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ù† Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userProps = PropertiesService.getUserProperties();
    const requestId = userProps.getProperty(String(chatId) + '_status_request_id');
    
    if (!requestId) {
      sendMessage(chatId, 'âŒ Request ID not found.', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back', callback_data: 'admin_panel' }]
          ]
        }
      });
      return;
    }
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙ Ø§Ù„Ø¨Ù„Ø§Øº
    const data = dataSheet.getDataRange().getValues();
    let rowIdx = -1;
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]) === String(requestId)) {
        rowIdx = i;
        break;
      }
    }
    
    if (rowIdx === -1) {
      sendMessage(chatId, 'âŒ Request not found.', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back', callback_data: 'admin_panel' }]
          ]
        }
      });
      return;
    }
    
    const now = new Date();
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº
    dataSheet.getRange(rowIdx + 1, 2).setValue(status); // Status
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© "Ù…ØºÙ„Ù‚"ØŒ ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    if (status === STATUS.CLOSED) {
      dataSheet.getRange(rowIdx + 1, 15).setValue(now); // Closed Date
      dataSheet.getRange(rowIdx + 1, 12).setValue(getUserNameById(chatId)); // Closed By
    }
    
    // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
    recordTimeline(requestId, status, chatId, `Status changed to ${status}`);
    
    // Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
    userProps.setProperty(String(chatId) + '_comment_request_id', requestId);
    
    sendMessage(chatId, `âœ… Status for request #${requestId} updated to ${status}.\n\nAdd a comment about this update (or type "Skip" to skip):`, {
      reply_markup: {
        force_reply: true
      }
    });
    
    userProps.setProperty(String(chatId), STATES.AWAITING_COMMENT);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø¹ÙŠÙ† (Ø¥Ù† ÙˆØ¬Ø¯)
    const assignedTo = data[rowIdx][3];
    if (assignedTo && assignedTo !== chatId) {
      sendMessage(assignedTo, `ğŸ”” Update: Request #${requestId} status has been changed to ${status}.`);
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø¨Ù„Ø§Øº
    const createdBy = data[rowIdx][10];
    if (createdBy && !isNaN(createdBy)) {
      sendMessage(createdBy, `ğŸ”” Update: Your request #${requestId} status has been changed to ${status}.`);
    }
    
    // Ù…Ø³Ø­ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ù† Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    userProps.deleteProperty(String(chatId) + '_status_request_id');
  } catch (err) {
    Logger.log(`updateRequestStatus error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error updating request status.');
  }
}

/**
 * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
 */
function handleCommentAddition(chatId, comment, userProps, userId) {
  try {
    const requestId = userProps.getProperty(String(chatId) + '_comment_request_id');
    
    if (!requestId) {
      sendMessage(chatId, 'âŒ Request ID not found.', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back', callback_data: 'admin_panel' }]
          ]
        }
      });
      resetUserState(userProps, chatId);
      return;
    }
    
    if (comment.toLowerCase() === 'skip') {
      sendMessage(chatId, 'âœ… No comment added.', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back to Admin Panel', callback_data: 'admin_panel' }]
          ]
        }
      });
      resetUserState(userProps, chatId);
      return;
    }
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙ Ø§Ù„Ø¨Ù„Ø§Øº
    const data = dataSheet.getDataRange().getValues();
    let rowIdx = -1;
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]) === String(requestId)) {
        rowIdx = i;
        break;
      }
    }
    
    if (rowIdx === -1) {
      sendMessage(chatId, 'âŒ Request not found.', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'â¬…ï¸ Back', callback_data: 'admin_panel' }]
          ]
        }
      });
      resetUserState(userProps, chatId);
      return;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ù„Ø§Øº
    const existingComment = data[rowIdx][9] || '';
    const updatedComment = existingComment ? 
      `${existingComment}\n${new Date().toLocaleString()}: ${comment}` : 
      `${new Date().toLocaleString()}: ${comment}`;
    
    dataSheet.getRange(rowIdx + 1, 10).setValue(updatedComment); // Comments
    
    // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
    recordTimeline(requestId, 'Comment Added', chatId, comment);
    
    // Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù…Ø´Ø±Ù
    sendMessage(chatId, `âœ… Comment added to request #${requestId}.`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'â¬…ï¸ Back to Admin Panel', callback_data: 'admin_panel' }]
        ]
      }
    });
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø¹ÙŠÙ† (Ø¥Ù† ÙˆØ¬Ø¯)
    const assignedTo = data[rowIdx][3];
    if (assignedTo && assignedTo !== chatId) {
      sendMessage(assignedTo, `ğŸ”” New comment on request #${requestId}: "${comment}"`);
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø¨Ù„Ø§Øº
    const createdBy = data[rowIdx][10];
    if (createdBy && !isNaN(createdBy)) {
      sendMessage(createdBy, `ğŸ”” New comment on your request #${requestId}: "${comment}"`);
    }
    
    resetUserState(userProps, chatId);
  } catch (err) {
    Logger.log(`handleCommentAddition error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error adding comment to request.');
    resetUserState(userProps, chatId);
  }
}

/**
 * Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù
 */
function showAdminDashboard(chatId) {
  try {
    const summary = computeDetailedSummary();
    
    // Ø¥Ø±Ø³Ø§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    sendMessage(chatId, summary, {
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'ğŸ‘¥ Users', callback_data: 'users:manage' },
            { text: 'ğŸ”„ Assign', callback_data: 'assign:menu' }
          ],
          [
            { text: 'ğŸ“Š View Report', callback_data: 'report:view' },
            { text: 'â° Check Pending', callback_data: 'requests:check_pending' }
          ],
          [
            { text: 'â¬…ï¸ Back to Main Menu', callback_data: 'back_main' }
          ]
        ]
      }
    });
  } catch (err) {
    Logger.log(`showAdminDashboard error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error showing admin dashboard.');
  }
}

/**
 * Ø­Ø³Ø§Ø¨ Ù…Ù„Ø®Øµ Ù…ÙØµÙ„ Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª
 */
function computeDetailedSummary() {
  try {
    const data = dataSheet.getDataRange().getValues();
    const total = data.length - 1; // Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø£Ø³
    
    if (total === 0) {
      return 'ğŸ“Š No maintenance requests recorded yet.';
    }
    
    // Ø§Ù„Ø¹Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
    const openCount = data.filter(row => row[1] === STATUS.OPEN).length;
    const inProgressCount = data.filter(row => row[1] === STATUS.IN_PROGRESS).length;
    const closedCount = data.filter(row => row[1] === STATUS.CLOSED).length;
    const pendingCount = data.filter(row => row[1] === STATUS.PENDING).length;
    
    // Ø§Ù„Ø¹Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    const civilCount = data.filter(row => row[2]?.toLowerCase() === 'civil').length;
    const electricalCount = data.filter(row => row[2]?.toLowerCase() === 'electrical').length;
    const mechanicalCount = data.filter(row => row[2]?.toLowerCase() === 'mechanical').length;
    
    // Ø§Ù„Ø¹Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
    const urgentCount = data.filter(row => row[4] === PRIORITIES.URGENT && row[1] !== STATUS.CLOSED).length;
    const highCount = data.filter(row => row[4] === PRIORITIES.HIGH && row[1] !== STATUS.CLOSED).length;
    
    // Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø¢Ø®Ø± 24 Ø³Ø§Ø¹Ø©
    const oneDayAgo = new Date();
    oneDayAgo.setDate(oneDayAgo.getDate() - 1);
    const newRequestsCount = data.filter(row => {
      if (row[12]) {
        const createDate = new Date(row[12]);
        return createDate >= oneDayAgo;
      }
      return false;
    }).length;
    
    // Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© (Ù…ÙØªÙˆØ­Ø© Ù„Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø£ÙŠØ§Ù…)
    const threeDaysAgo = new Date();
    threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
    const delayedRequestsCount = data.filter(row => {
      if (row[12] && row[1] !== STATUS.CLOSED) {
        const createDate = new Date(row[12]);
        return createDate <= threeDaysAgo;
      }
      return false;
    }).length;
    
    // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø­Ù„ Ù„Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…ØºÙ„Ù‚Ø©
    let avgResolutionTime = 'N/A';
    const closedTickets = data.filter(row => row[1] === STATUS.CLOSED && row[12] && row[14]);
    
    if (closedTickets.length > 0) {
      const totalHours = closedTickets.reduce((sum, ticket) => {
        const createDate = new Date(ticket[12]);
        const closeDate = new Date(ticket[14]);
        const diffHours = (closeDate - createDate) / (1000 * 60 * 60);
        return sum + diffHours;
      }, 0);
      
      avgResolutionTime = `${(totalHours / closedTickets.length).toFixed(1)} hours`;
    }
    
    // Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ù†Ø¬Ø§Ø²Ù‹Ø§
    const techCompletions = {};
    data.filter(row => row[1] === STATUS.CLOSED && row[3]).forEach(row => {
      const techId = row[3];
      techCompletions[techId] = (techCompletions[techId] || 0) + 1;
    });
    
    let topTechId = null;
    let topTechCount = 0;
    
    for (const [techId, count] of Object.entries(techCompletions)) {
      if (count > topTechCount) {
        topTechId = techId;
        topTechCount = count;
      }
    }
    
    const topTechName = topTechId ? getUserNameById(topTechId) || topTechId : 'N/A';
    
    return `ğŸ“Š Maintenance Dashboard\n\nTotal Requests: ${total}\n\n` +
      `By Status:\n` +
      `â€¢ ğŸ”´ Open: ${openCount} (${Math.round(openCount/total*100)}%)\n` +
      `â€¢ ğŸŸ  In Progress: ${inProgressCount} (${Math.round(inProgressCount/total*100)}%)\n` +
      `â€¢ ğŸŸ¢ Closed: ${closedCount} (${Math.round(closedCount/total*100)}%)\n` +
      `â€¢ âšª Pending: ${pendingCount} (${Math.round(pendingCount/total*100)}%)\n\n` +
      
      `By Type:\n` +
      `â€¢ Civil: ${civilCount} (${Math.round(civilCount/total*100)}%)\n` +
      `â€¢ Electrical: ${electricalCount} (${Math.round(electricalCount/total*100)}%)\n` +
      `â€¢ Mechanical: ${mechanicalCount} (${Math.round(mechanicalCount/total*100)}%)\n\n` +
      
      `Highlights:\n` +
      `â€¢ âš ï¸ Urgent requests: ${urgentCount}\n` +
      `â€¢ âš¡ High priority: ${highCount}\n` +
      `â€¢ ğŸ•’ Delayed requests: ${delayedRequestsCount}\n` +
      `â€¢ ğŸ†• New in 24h: ${newRequestsCount}\n` +
      `â€¢ ğŸ‘¨â€ğŸ”§ Top tech: ${topTechName} (${topTechCount} closures)\n` +
      `â€¢ â±ï¸ Avg resolution: ${avgResolutionTime}`;
  } catch (err) {
    Logger.log(`computeDetailedSummary error: ${err.message}\n${err.stack}`);
    return 'âš ï¸ Error calculating detailed summary.';
  }
}

/**
 * ÙØ­Øµ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ†
 */
function checkPendingRequests(chatId) {
  try {
    const data = dataSheet.getDataRange().getValues();
    
    // Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø£ÙŠØ§Ù…)
    const openDelayThreshold = new Date();
    openDelayThreshold.setDate(openDelayThreshold.getDate() - REMINDER_DAYS.OPEN);
    
    const delayedOpenRequests = data.filter((row, idx) => {
      if (idx > 0 && row[1] === STATUS.OPEN && row[12]) {
        const createDate = new Date(row[12]);
        return createDate <= openDelayThreshold;
      }
      return false;
    });
    
    // Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø£ÙŠØ§Ù…)
    const inProgressDelayThreshold = new Date();
    inProgressDelayThreshold.setDate(inProgressDelayThreshold.getDate() - REMINDER_DAYS.IN_PROGRESS);
    
    const delayedInProgressRequests = data.filter((row, idx) => {
      if (idx > 0 && row[1] === STATUS.IN_PROGRESS && row[12]) {
        const createDate = new Date(row[12]);
        return createDate <= inProgressDelayThreshold;
      }
      return false;
    });
    
    // Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© ÙˆØ§Ù„Ø¹Ø§Ø¬Ù„Ø©
    const highPriorityRequests = data.filter((row, idx) => {
      if (idx > 0 && (row[1] === STATUS.OPEN || row[1] === STATUS.IN_PROGRESS)) {
        return row[4] === PRIORITIES.URGENT || row[4] === PRIORITIES.HIGH;
      }
      return false;
    });
    
    // Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¹ÙŠÙ†Ø©
    const unassignedRequests = data.filter((row, idx) => 
      idx > 0 && row[1] === STATUS.OPEN && !row[3]
    );
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
    let alertMessage = 'âš ï¸ Maintenance Alerts:\n\n';
    
    if (delayedOpenRequests.length > 0) {
      alertMessage += `ğŸ•’ ${delayedOpenRequests.length} open request(s) delayed more than ${REMINDER_DAYS.OPEN} days:\n`;
      delayedOpenRequests.slice(0, 5).forEach(row => {
        alertMessage += `â€¢ #${row[0]} - ${row[2]} - ${formatDate(row[12])}\n`;
      });
      if (delayedOpenRequests.length > 5) {
        alertMessage += `... and ${delayedOpenRequests.length - 5} more\n`;
      }
      alertMessage += '\n';
    }
    
    if (delayedInProgressRequests.length > 0) {
      alertMessage += `ğŸ•’ ${delayedInProgressRequests.length} in-progress request(s) delayed more than ${REMINDER_DAYS.IN_PROGRESS} days:\n`;
      delayedInProgressRequests.slice(0, 5).forEach(row => {
        alertMessage += `â€¢ #${row[0]} - ${row[2]} - ${formatDate(row[12])}\n`;
      });
      if (delayedInProgressRequests.length > 5) {
        alertMessage += `... and ${delayedInProgressRequests.length - 5} more\n`;
      }
      alertMessage += '\n';
    }
    
    if (highPriorityRequests.length > 0) {
      alertMessage += `ğŸ”¥ ${highPriorityRequests.length} high priority request(s):\n`;
      highPriorityRequests.slice(0, 5).forEach(row => {
        alertMessage += `â€¢ #${row[0]} - ${row[4]} - ${row[2]} - ${formatDate(row[12])}\n`;
      });
      if (highPriorityRequests.length > 5) {
        alertMessage += `... and ${highPriorityRequests.length - 5} more\n`;
      }
      alertMessage += '\n';
    }
    
    if (unassignedRequests.length > 0) {
      alertMessage += `ğŸ“ ${unassignedRequests.length} unassigned request(s):\n`;
      unassignedRequests.slice(0, 5).forEach(row => {
        alertMessage += `â€¢ #${row[0]} - ${row[2]} - ${formatDate(row[12])}\n`;
      });
      if (unassignedRequests.length > 5) {
        alertMessage += `... and ${unassignedRequests.length - 5} more\n`;
      }
      alertMessage += '\n';
    }
    
    if (delayedOpenRequests.length === 0 && 
        delayedInProgressRequests.length === 0 && 
        highPriorityRequests.length === 0 && 
        unassignedRequests.length === 0) {
      alertMessage = 'âœ… No pending alerts! All maintenance requests are on track.';
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
    sendMessage(chatId, alertMessage, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'â¬…ï¸ Back to Admin Panel', callback_data: 'admin_panel' }]
        ]
      }
    });
  } catch (err) {
    Logger.log(`checkPendingRequests error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error checking pending requests.');
  }
}

/**
 * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ø¹Ø±Ø¶
 */
function formatDate(dateValue) {
  try {
    if (!dateValue) return 'N/A';
    
    const date = new Date(dateValue);
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
  } catch (err) {
    return 'Invalid Date';
  }
}

/**
 * Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨
 */
function showWebReport(chatId) {
  try {
    // Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ Ø¨Ø³ÙŠØ·
    const webAppUrl = ScriptApp.getService().getUrl();
    const reportUrl = webAppUrl + '?page=report';
    
    sendMessage(chatId, `ğŸ“Š View detailed reports online:\n\n${reportUrl}\n\nThis link provides an interactive dashboard of all maintenance requests.`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'â¬…ï¸ Back to Admin Panel', callback_data: 'admin_panel' }]
        ]
      }
    });
  } catch (err) {
    Logger.log(`showWebReport error: ${err.message}\n${err.stack}`);
    sendMessage(chatId, 'âš ï¸ Error generating web report link.');
  }
}

/**
 * ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
 */
function recordTimeline(requestId, status, userId, comments, timestamp = new Date()) {
  try {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (!timelineSheet) {
      Logger.log('Timeline sheet not initialized');
      return;
    }
    
    // ØªØ­ÙˆÙŠÙ„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ø³Ù…Ù‡ Ø¥Ù† Ø£Ù…ÙƒÙ†
    let updatedBy = getUserNameById(userId);
    if (!updatedBy) {
      updatedBy = String(userId);
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
    timelineSheet.appendRow([
      requestId,
      status,
      updatedBy,
      comments,
      timestamp
    ]);
  } catch (err) {
    Logger.log(`recordTimeline error: ${err.message}\n${err.stack}`);
  }
}

/**
 * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
 */
function handleAdvancedAdminFlow(msg, chatId, userId, text, lower, state, userProps) {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±Ù Ø£Ùˆ ÙÙ†ÙŠ
  if (!isAuthorized(userId)) {
    return false;
  }
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
  if (state === STATES.AWAITING_ASSIGN_TECH) {
    // Ø­Ø§Ù„Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ
    handleTechAssignment(chatId, text, userProps);
    return true;
  }
  
  if (state === STATES.AWAITING_PRIORITY) {
    // Ø­Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
    handlePriorityAssignment(chatId, text, userProps);
    return true;
  }
  
  if (state === STATES.AWAITING_STATUS